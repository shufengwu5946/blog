---
title: JavaScript从垃圾回收角度理解闭包原理
date: 
tags:
    - 垃圾回收
    - 闭包
---

# JavaScript 垃圾回收机制

JavaScript中对内存的回收完全实现了自动管理，比较复杂，不展开讲解。

**原理**可以简单理解为：垃圾收集器按照固定的时间间隔周期性地进行垃圾回收操作，找出那些不再继续使用的变量，然后释放其所占用的内存。

# 函数执行

## 执行环境(Execution Context,也叫执行上下文)

在执行代码的时候，会首先进入一个执行环境，执行环境包括两种情形，全局执行环境（window对象）和函数执行环境，JavaScript代码运行起来会首先进入该全局执行环境，当调用函数的时候，也都会给函数创建一个这样的执行环境。JavaScript引擎会以栈的方式来处理它们，栈底永远都是全局上下文，而栈顶就是当前正在执行的上下文。进入某个执行环境的时候，会放入栈顶，而处于栈顶的执行环境执行完毕之后，就会自动出栈。

执行环境的生命周期分为两个阶段：

**（1）创建阶段**

创建变量对象，建立作用域链，确定this指向等。

**（2）执行阶段**

创建完成之后，就会开始执行代码，这个时候进行变量赋值、函数引用、其他代码执行等造作。

### 变量对象

每个执行环境都有一个与之关联的变量对象，环境中定义的所有变量、函数都保存在这个对象中，我们编写的代码无法访问这个对象，解释器会用到。

### 作用域链

执行到一个执行环境的时候，会为当前执行环境增加一个scope属性，指向作用域链。作用域链的前端，始终都是指向当前代码所在执行环境的变量对象，作用域链的下一位置指向外层包含执行环境的变量对象，这样，作用域链一直延续到全局执行环境的变量对象。

变量的查找就是沿着这条作用域链进行。

我们以下面代码举例：
```javascript
function f1() {
    var n = 999;
    function f2() {
        console.log(n);
    }
    return f2;
}

var result = f1();
result(); // 999
```
f2的函数的执行环境创建阶段会形成如下结构：









https://mp.weixin.qq.com/s?__biz=MjM5MTA1MjAxMQ==&mid=2651228474&idx=1&sn=031ea46ca182f2dacf8f65cc30c6566b&chksm=bd4950be8a3ed9a87e24c664dec77bd63bb69e735887ea33dc574358070affb0fbf6eafd9f0b&mpshare=1&scene=1&srcid=1204q5xZR2W0Kw6u5utapapz#rd

https://segmentfault.com/a/1190000003021472

https://www.cnblogs.com/lsgxeva/p/7976034.html




